/*! WysiBB - WYSIWYG BBCode editor - v1.4.2 - 2013-04-06
* http://www.wysibb.com
* Copyright (c) 2013 Vadim Dobroskok; Licensed MIT, GPL */
"undefined"==typeof WBBLANG&&(WBBLANG={});
WBBLANG.en=CURLANG={bold:"Bold",italic:"Italic",underline:"Underline",strike:"Strike",link:"Link",img:"Insert image",sup:"Superscript",sub:"Subscript",justifyleft:"Align left",justifycenter:"Align center",justifyright:"Align right",table:"Insert table",bullist:"\u2022 Unordered list",numlist:"1. Ordered list",quote:"Quote",offtop:"Offtop",code:"Code",spoiler:"Spoiler",fontcolor:"Font color",fontsize:"Font size",fontfamily:"Font family",fs_verysmall:"Very small",fs_small:"Small",fs_normal:"Normal",
fs_big:"Big",fs_verybig:"Very big",smilebox:"Insert emoticon",video:"Embed a video",removeFormat:"Remove Format",modal_link_title:"Insert link",modal_link_text:"Display text",modal_link_url:"URL",modal_email_text:"Display email",modal_email_url:"Email",modal_link_tab1:"Insert URL",modal_img_title:"Insert image",modal_img_tab1:"Insert URL",modal_img_tab2:"Upload image",modal_imgsrc_text:"Enter image URL",modal_img_btn:"Choose file",add_attach:"Add Attachment",modal_video_text:"Enter the URL of the video",
close:"Close",save:"Save",cancel:"Cancel",remove:"Delete",validation_err:"The entered data is invalid",error_onupload:"Error during file upload",fileupload_text1:"Drop file here",fileupload_text2:"or",loading:"Loading",auto:"Auto",views:"Views",downloads:"Downloads",sm1:"Smile",sm2:"Laughter",sm3:"Wink",sm4:"Thank you",sm5:"Scold",sm6:"Shock",sm7:"Angry",sm8:"Pain",sm9:"Sick"};wbbdebug=!0;
(function(b){b.wysibb=function(a,c){b(a).data("wbb",this);c&&(c.deflang&&"undefined"!=typeof WBBLANG[c.deflang])&&(CURLANG=WBBLANG[c.deflang]);c&&(c.lang&&"undefined"!=typeof WBBLANG[c.lang])&&(CURLANG=WBBLANG[c.lang]);this.txtArea=a;this.$txtArea=b(a);var d=this.$txtArea.attr("id")||this.setUID(this.txtArea);this.options={bbmode:!1,onlyBBmode:!1,themeName:"default",bodyClass:"",lang:"ru",tabInsert:!0,imgupload:!0,img_uploadurl:"/iupload.php",img_maxwidth:800,img_maxheight:800,hotkeys:!0,showHotkeys:!0,
autoresize:!0,resize_maxheight:800,loadPageStyles:!0,traceTextarea:!0,smileConversion:!0,buttons:"bold,italic,underline,strike,sup,sub,|,img,video,link,|,bullist,numlist,smilebox,|,fontcolor,fontsize,fontfamily,|,justifyleft,justifycenter,justifyright,|,quote,code,offtop,table,removeFormat",allButtons:{bold:{title:CURLANG.bold,buttonHTML:'<span class="fonticon ve-tlb-bold1">\ue018</span>',excmd:"bold",hotkey:"ctrl+b",transform:{"<b>{SELTEXT}</b>":"[b]{SELTEXT}[/b]","<strong>{SELTEXT}</strong>":"[b]{SELTEXT}[/b]"}},
italic:{title:CURLANG.italic,buttonHTML:'<span class="fonticon ve-tlb-italic1">\ue001</span>',excmd:"italic",hotkey:"ctrl+i",transform:{"<i>{SELTEXT}</i>":"[i]{SELTEXT}[/i]","<em>{SELTEXT}</em>":"[i]{SELTEXT}[/i]"}},underline:{title:CURLANG.underline,buttonHTML:'<span class="fonticon ve-tlb-underline1">\ue002</span>',excmd:"underline",hotkey:"ctrl+u",transform:{"<u>{SELTEXT}</u>":"[u]{SELTEXT}[/u]"}},strike:{title:CURLANG.strike,buttonHTML:'<span class="fonticon fi-stroke1 ve-tlb-strike1">\ue003</span>',
excmd:"strikeThrough",transform:{"<strike>{SELTEXT}</strike>":"[s]{SELTEXT}[/s]","<s>{SELTEXT}</s>":"[s]{SELTEXT}[/s]"}},sup:{title:CURLANG.sup,buttonHTML:'<span class="fonticon ve-tlb-sup1">\ue005</span>',excmd:"superscript",transform:{"<sup>{SELTEXT}</sup>":"[sup]{SELTEXT}[/sup]"}},sub:{title:CURLANG.sub,buttonHTML:'<span class="fonticon ve-tlb-sub1">\ue004</span>',excmd:"subscript",transform:{"<sub>{SELTEXT}</sub>":"[sub]{SELTEXT}[/sub]"}},link:{title:CURLANG.link,buttonHTML:'<span class="fonticon ve-tlb-link1">\ue007</span>',
hotkey:"ctrl+shift+2",modal:{title:CURLANG.modal_link_title,width:"500px",tabs:[{input:[{param:"SELTEXT",title:CURLANG.modal_link_text,type:"div"},{param:"URL",title:CURLANG.modal_link_url,validation:"^http(s)?://"}]}]},transform:{'<a href="{URL}">{SELTEXT}</a>':"[url={URL}]{SELTEXT}[/url]",'<a href="{URL}">{URL}</a>':"[url]{URL}[/url]"}},img:{title:CURLANG.img,buttonHTML:'<span class="fonticon ve-tlb-img1">\ue006</span>',hotkey:"ctrl+shift+1",modal:{title:CURLANG.modal_img_title,width:"600px",tabs:[{title:CURLANG.modal_img_tab1,
input:[{param:"SRC",title:CURLANG.modal_imgsrc_text,validation:"^http(s)?://.*?.(jpg|png|gif|jpeg)$"}]},{title:CURLANG.modal_img_tab2,html:'<div id="imguploader"> <form id="fupform" class="upload" action="{img_uploadurl}" method="post" enctype="multipart/form-data" target="fupload"><input type="hidden" name="iframe" value="1"/><input type="hidden" name="idarea" value="'+d+'" /><div class="fileupload"><input id="fileupl" class="file" type="file" name="img" /><button id="nicebtn" class="wbb-button">'+
CURLANG.modal_img_btn+'</button> </div> </form> </div><iframe id="fupload" name="fupload" src="about:blank" frameborder="0" style="width:0px;height:0px;display:none"></iframe></div>'}],onLoad:this.imgLoadModal},transform:{'<img src="{SRC}" />':"[img]{SRC}[/img]",'<img src="{SRC}" width="{WIDTH}" height="{HEIGHT}"/>':"[img width={WIDTH},height={HEIGHT}]{SRC}[/img]"}},bullist:{title:CURLANG.bullist,buttonHTML:'<span class="fonticon ve-tlb-list1">\ue009</span>',excmd:"insertUnorderedList",transform:{"<ul>{SELTEXT}</ul>":"[list]{SELTEXT}[/list]",
"<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},numlist:{title:CURLANG.numlist,buttonHTML:'<span class="fonticon ve-tlb-numlist1">\ue00a</span>',excmd:"insertOrderedList",transform:{"<ol>{SELTEXT}</ol>":"[list=1]{SELTEXT}[/list]","<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},quote:{title:CURLANG.quote,buttonHTML:'<span class="fonticon ve-tlb-quote1">\ue00c</span>',hotkey:"ctrl+shift+3",transform:{'<div class="quote">{SELTEXT}</div>':"[quote]{SELTEXT}[/quote]"}},code:{title:CURLANG.code,buttonText:"[code]",
hotkey:"ctrl+shift+4",onlyClearText:!0,transform:{'<div class="codewrap"><div class="codetop" contenteditable="false">\u041a\u043e\u0434:</div><div class="codemain">{SELTEXT}</div></div>':"[code]{SELTEXT}[/code]"}},offtop:{title:CURLANG.offtop,buttonText:"offtop",transform:{'<span style="font-size:10px;color:#ccc">{SELTEXT}</span>':"[offtop]{SELTEXT}[/offtop]"}},fontcolor:{type:"colorpicker",title:CURLANG.fontcolor,excmd:"foreColor",valueBBname:"color",subInsert:!0,colors:"#000000,#444444,#666666,#999999,#b6b6b6,#cccccc,#d8d8d8,#efefef,#f4f4f4,#ffffff,-, \t\t\t\t\t\t\t #ff0000,#980000,#ff7700,#ffff00,#00ff00,#00ffff,#1e84cc,#0000ff,#9900ff,#ff00ff,-, \t\t\t\t\t\t\t #f4cccc,#dbb0a7,#fce5cd,#fff2cc,#d9ead3,#d0e0e3,#c9daf8,#cfe2f3,#d9d2e9,#ead1dc, \t\t\t\t\t\t\t #ea9999,#dd7e6b,#f9cb9c,#ffe599,#b6d7a8,#a2c4c9,#a4c2f4,#9fc5e8,#b4a7d6,#d5a6bd, \t\t\t\t\t\t\t #e06666,#cc4125,#f6b26b,#ffd966,#93c47d,#76a5af,#6d9eeb,#6fa8dc,#8e7cc3,#c27ba0, \t\t\t\t\t\t\t #cc0000,#a61c00,#e69138,#f1c232,#6aa84f,#45818e,#3c78d8,#3d85c6,#674ea7,#a64d79, \t\t\t\t\t\t\t #900000,#85200C,#B45F06,#BF9000,#38761D,#134F5C,#1155Cc,#0B5394,#351C75,#741B47, \t\t\t\t\t\t\t #660000,#5B0F00,#783F04,#7F6000,#274E13,#0C343D,#1C4587,#073763,#20124D,#4C1130",
transform:{'<font color="{COLOR}">{SELTEXT}</font>':"[color={COLOR}]{SELTEXT}[/color]"}},table:{type:"table",title:CURLANG.table,cols:10,rows:10,cellwidth:15,transform:{"<td>{SELTEXT}</td>":"[td]{SELTEXT}[/td]","<tr>{SELTEXT}</tr>":"[tr]{SELTEXT}[/tr]",'<table class="wbb-table">{SELTEXT}</table>':"[table]{SELTEXT}[/table]"},skipRules:!0},fontsize:{type:"select",title:CURLANG.fontsize,options:"fs_verysmall,fs_small,fs_normal,fs_big,fs_verybig"},fontfamily:{type:"select",title:CURLANG.fontfamily,excmd:"fontName",
valueBBname:"font",options:[{title:"Arial",exvalue:"Arial"},{title:"Comic Sans MS",exvalue:"Comic Sans MS"},{title:"Courier New",exvalue:"Courier New"},{title:"Georgia",exvalue:"Georgia"},{title:"Lucida Sans Unicode",exvalue:"Lucida Sans Unicode"},{title:"Tahoma",exvalue:"Tahoma"},{title:"Times New Roman",exvalue:"Times New Roman"},{title:"Trebuchet MS",exvalue:"Trebuchet MS"},{title:"Verdana",exvalue:"Verdana"}],transform:{'<font face="{FONT}">{SELTEXT}</font>':"[font={FONT}]{SELTEXT}[/font]"}},
smilebox:{type:"smilebox",title:CURLANG.smilebox,buttonHTML:'<span class="fonticon ve-tlb-smilebox1">\ue00b</span>'},justifyleft:{title:CURLANG.justifyleft,buttonHTML:'<span class="fonticon ve-tlb-textleft1">\ue015</span>',groupkey:"align",transform:{'<p style="text-align:left">{SELTEXT}</p>':"[align=left]{SELTEXT}[/align]"}},justifyright:{title:CURLANG.justifyright,buttonHTML:'<span class="fonticon ve-tlb-textright1">\ue016</span>',groupkey:"align",transform:{'<p style="text-align:right">{SELTEXT}</p>':"[align=right]{SELTEXT}[/align]"}},
justifycenter:{title:CURLANG.justifycenter,buttonHTML:'<span class="fonticon ve-tlb-textcenter1">\ue014</span>',groupkey:"align",transform:{'<p style="text-align:center">{SELTEXT}</p>':"[align=center]{SELTEXT}[/align]"}},video:{title:CURLANG.video,buttonHTML:'<span class="fonticon ve-tlb-video1">\ue008</span>',modal:{title:CURLANG.video,width:"600px",tabs:[{title:CURLANG.video,input:[{param:"SRC",title:CURLANG.modal_video_text}]}],onSubmit:function(a,b,c){(b=this.$modal.find('input[name="SRC"]').val())&&
(b=b.replace(/^\s+/,"").replace(/\s+$/,""));(b=-1!=b.indexOf("youtu.be")?b.match(/^http:\/\/youtu\.be\/([a-z0-9_-]+)/i):b.match(/^http:\/\/www\.youtube\.com\/watch\?.*?v=([a-z0-9_-]+)/i))&&2==b.length&&this.insertAtCursor(this.getCodeByCommand(a,{src:b[1]}));this.closeModal();this.updateUI();return!1}},transform:{'<iframe src="http://www.youtube.com/embed/{SRC}" width="640" height="480" frameborder="0"></iframe>':"[video]{SRC}[/video]"}},fs_verysmall:{title:CURLANG.fs_verysmall,buttonText:"fs1",excmd:"fontSize",
exvalue:"1",transform:{'<font style="font-size: 30%;">{SELTEXT}</font>':"[size=3]{SELTEXT}[/size]"}},fs_small:{title:CURLANG.fs_small,buttonText:"fs2",excmd:"fontSize",exvalue:"2",transform:{'<font style="font-size: 50%;">{SELTEXT}</font>':"[size=5]{SELTEXT}[/size]"}},fs_normal:{title:CURLANG.fs_normal,buttonText:"fs3",excmd:"fontSize",exvalue:"3",transform:{'<font style="font-size: 100%;">{SELTEXT}</font>':"[size=10]{SELTEXT}[/size]"}},fs_big:{title:CURLANG.fs_big,buttonText:"fs4",excmd:"fontSize",
exvalue:"5",transform:{'<font style="font-size: 150%;">{SELTEXT}</font>':"[size=15]{SELTEXT}[/size]"}},fs_verybig:{title:CURLANG.fs_verybig,buttonText:"fs5",excmd:"fontSize",exvalue:"7",transform:{'<font style="font-size: 300%;">{SELTEXT}</font>':"[size=30]{SELTEXT}[/size]"}},removeformat:{title:CURLANG.removeFormat,buttonHTML:'<span class="fonticon ve-tlb-removeformat1">\ue00f</span>',excmd:"removeFormat"}},systr:{"<br/>":"\n",'<span class="wbbtab">{SELTEXT}</span>':"   {SELTEXT}"},customRules:{td:[["[td]{SELTEXT}[/td]",
{seltext:{rgx:!1,attr:!1,sel:!1}}]],tr:[["[tr]{SELTEXT}[/tr]",{seltext:{rgx:!1,attr:!1,sel:!1}}]],table:[["[table]{SELTEXT}[/table]",{seltext:{rgx:!1,attr:!1,sel:!1}}]]},smileList:[{title:CURLANG.sm1,img:'<img src="{themePrefix}{themeName}/img/smiles/sm1.png" class="sm">',bbcode:":)"},{title:CURLANG.sm8,img:'<img src="{themePrefix}{themeName}/img/smiles/sm8.png" class="sm">',bbcode:":("},{title:CURLANG.sm1,img:'<img src="{themePrefix}{themeName}/img/smiles/sm2.png" class="sm">',bbcode:":D"},{title:CURLANG.sm3,
img:'<img src="{themePrefix}{themeName}/img/smiles/sm3.png" class="sm">',bbcode:";)"},{title:CURLANG.sm4,img:'<img src="{themePrefix}{themeName}/img/smiles/sm4.png" class="sm">',bbcode:":up:"},{title:CURLANG.sm5,img:'<img src="{themePrefix}{themeName}/img/smiles/sm5.png" class="sm">',bbcode:":down:"},{title:CURLANG.sm6,img:'<img src="{themePrefix}{themeName}/img/smiles/sm6.png" class="sm">',bbcode:":shock:"},{title:CURLANG.sm7,img:'<img src="{themePrefix}{themeName}/img/smiles/sm7.png" class="sm">',
bbcode:":angry:"},{title:CURLANG.sm9,img:'<img src="{themePrefix}{themeName}/img/smiles/sm9.png" class="sm">',bbcode:":sick:"}],attrWrap:["src","color","href"]};this.inited=this.options.onlyBBmode;this.options.themePrefix||b("link").each(b.proxy(function(a,c){var d=b(c).get(0).href.match(/(.*\/)(.*)\/wbbtheme\.css.*$/);null!==d&&(this.options.themeName=d[2],this.options.themePrefix=d[1])},this));"undefined"!=typeof WBBPRESET&&(WBBPRESET.allButtons&&b.each(WBBPRESET.allButtons,b.proxy(function(a,b){b.transform&&
this.options.allButtons[a]&&delete this.options.allButtons[a].transform},this)),b.extend(!0,this.options,WBBPRESET));c&&c.allButtons&&b.each(c.allButtons,b.proxy(function(a,b){b.transform&&this.options.allButtons[a]&&delete this.options.allButtons[a].transform},this));b.extend(!0,this.options,c);this.init()};b.wysibb.prototype={lastid:1,init:function(){b.log("Init",this);/android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|meego.+mobile|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent||
navigator.vendor||window.opera);this.isMobile=void 0;!0===this.options.onlyBBmode&&(this.options.bbmode=!0);this.controllers=[];this.options.buttons=this.options.buttons.toLowerCase();this.options.buttons=this.options.buttons.split(",");this.options.allButtons._systr={};this.options.allButtons._systr.transform=this.options.systr;this.smileFind();this.initTransforms();this.build();this.initModal();!0===this.options.hotkeys&&!this.isMobile&&this.initHotkeys();this.options.smileList&&0<this.options.smileList.length&&
this.options.smileList.sort(function(a,b){return b.bbcode.length-a.bbcode.length});this.$txtArea.parents("form").bind("submit",b.proxy(function(){this.sync();return!0},this));this.$txtArea.parents("form").find("input[id*='preview'],input[id*='submit'],input[class*='preview'],input[class*='submit'],input[name*='preview'],input[name*='submit']").bind("mousedown",b.proxy(function(){this.sync();setTimeout(b.proxy(function(){!1===this.options.bbmode&&this.$txtArea.removeAttr("wbbsync").val("")},this),
1E3)},this));this.options.initCallback&&this.options.initCallback.call(this);b.log(this)},initTransforms:function(){b.log("Create rules for transform HTML=>BB");var a=this.options;a.rules||(a.rules={});a.groups||(a.groups={});var c=a.buttons.slice();c.push("_systr");for(var d=0;d<c.length;d++){var e=a.allButtons[c[d]];if(e){e.en=!0;e.simplebbcode&&(b.isArray(e.simplebbcode)&&2==e.simplebbcode.length)&&(e.bbcode=e.html=e.simplebbcode[0]+"{SELTEXT}"+e.simplebbcode[1],e.transform&&delete e.transform,
e.modal&&delete e.modal);if("select"==e.type&&"string"==typeof e.options){var f=e.options.split(",");b.each(f,function(a,d){-1==b.inArray(d,c)&&c.push(d)})}if(e.transform&&!0!==e.skipRules){var f=b.extend({},e.transform),g;for(g in f){var h=g,f=e.transform[g];e.bbSelector||(e.bbSelector=[]);-1==b.inArray(f,e.bbSelector)&&e.bbSelector.push(f);if(!1===this.options.onlyBBmode){g=this.wrapAttrs(g);var k=b(document.createElement("DIV")).append(b(this.elFromString(g,document))),l=this.filterByNode(k.children());
if("div"==l||"undefined"!=typeof a.rules[l])b.log("create unique selector: "+l),this.setUID(k.children()),l=this.filterByNode(k.children()),h=k.html(),h=this.unwrapAttrs(h),g=this.unwrapAttrs(g),e.transform[h]=f,delete e.transform[g],g=h;e.excmd||(e.rootSelector||(e.rootSelector=[]),e.rootSelector.push(l));"undefined"==typeof a.rules[l]&&(a.rules[l]=[]);var n={};g.match(/\{\S+?\}/)&&(k.find("*").each(b.proxy(function(a,c){var d=this.getAttributeList(c);b.each(d,b.proxy(function(a,d){var e=b(c).attr(d);
"_"==d.substr(0,1)&&(d=d.substr(1));var f=e.match(/\{\S+?\}/g);if(f)for(var g=0;g<f.length;g++){var h=f[g].substr(1,f[g].length-2),h=h.replace(this.getValidationRGX(h),""),k=this.relFilterByNode(c,l),m=e!=f[g]?this.getRegexpReplace(e,f[g]):!1;n[h.toLowerCase()]={sel:k?b.trim(k):!1,attr:d,rgx:m}}},this));var e=[];b(c).is("iframe")||b(c).contents().filter(function(){return 3===this.nodeType}).each(b.proxy(function(a,d){var f=d.textContent||d.data;if("undefined"==typeof f)return!0;var g=f.match(/\{\S+?\}/g);
if(g)for(var h=0;h<g.length;h++){var k=g[h].substr(1,g[h].length-2),k=k.replace(this.getValidationRGX(k),""),m=this.relFilterByNode(c,l),p=f!=g[h]?this.getRegexpReplace(f,g[h]):!1,m=m?b.trim(m):!1;if(-1<b.inArray(m,e)||1<b(d).parent().contents().size()){p=b("<span>").html("{"+k+"}");this.setUID(p,"wbb");var r=f.indexOf(k)+k.length+1,r=f.substr(r,f.length-r);d.data=f.substr(0,f.indexOf(k)-1);b(d).after(this.elFromString(r,document)).after(p);m=(m?m+" ":"")+this.filterByNode(p);p=!1}n[k.toLowerCase()]=
{sel:m,attr:!1,rgx:p};e[e.length]=m}},this));e=null},this)),k=k.html(),k=this.unwrapAttrs(k),h!=k&&(delete e.transform[h],e.transform[k]=f,g=k));a.rules[l].push([f,n]);!0===e.onlyClearText&&(this.cleartext||(this.cleartext={}),this.cleartext[l]=c[d]);e.groupkey&&(a.groups[e.groupkey]||(a.groups[e.groupkey]=[]),a.groups[e.groupkey].push(l))}}e.rootSelector&&this.sortArray(e.rootSelector,-1);f=b.map(e.transform,function(a,b){return b}).sort(function(a,b){return(b[0]||"").length-(a[0]||"").length});
e.bbcode=e.transform[f[0]];e.html=f[0]}}}this.options.btnlist=c;b.extend(a.rules,this.options.customRules);a.srules={};this.options.smileList&&b.each(a.smileList,b.proxy(function(c,d){var e=b(this.strf(d.img,a)),e=this.filterByNode(e);a.srules[e]=[d.bbcode,d.img]},this));for(var m in a.rules)this.options.rules[m].sort(function(a,b){return b[0].length-a[0].length});this.rsellist=[];for(m in this.options.rules)this.rsellist.push(m);this.sortArray(this.rsellist,-1)},build:function(){b.log("Build editor");
this.$editor=b("<div>").addClass("wysibb");this.options.direction&&this.$editor.css("direction",this.options.direction);this.$editor.insertAfter(this.txtArea).append(this.txtArea);this.startHeight=this.$txtArea.outerHeight();this.$txtArea.addClass("wysibb-texarea");this.buildToolbar();this.$txtArea.wrap('<div class="wysibb-text">');if(!1===this.options.onlyBBmode){var a=this.options.minheight||this.$txtArea.outerHeight();this.$body=b(this.strf('<div class="wysibb-text-editor" style="max-height:{maxheight}px;min-height:{height}px"></iframe>',
{maxheight:!0===this.options.autoresize?this.options.resize_maxheight:a,height:a})).insertAfter(this.$txtArea);this.body=this.$body[0];this.$txtArea.hide();b.log("WysiBB loaded");this.$body.addClass("wysibb-body").addClass(this.options.bodyClass);this.options.direction&&this.$body.css("direction",this.options.direction);if("contentEditable"in this.body){this.body.contentEditable=!0;try{document.execCommand("StyleWithCSS",!1,!1),this.$body.append("<span></span>")}catch(c){}}else this.options.onlyBBmode=
this.options.bbmode=!0;0<this.txtArea.value.length&&this.txtAreaInitContent();this.$body.bind("keydown",b.proxy(function(a){if(86==a.which&&(!0==a.ctrlKey||!0==a.metaKey)||45==a.which&&(!0==a.shiftKey||!0==a.metaKey))return this.$pasteBlock||(this.saveRange(),this.$pasteBlock=b(this.elFromString('<div style="opacity:0;" contenteditable="true">\ufeff</div>')),this.$pasteBlock.appendTo(this.body),b.support.htmlSerialize||this.$pasteBlock.focus(),setTimeout(b.proxy(function(){this.clearPaste(this.$pasteBlock);
var a="<span>"+this.$pasteBlock.html()+"</span>";this.$body.attr("contentEditable","true");this.$pasteBlock.blur().remove();this.body.focus();this.cleartext&&this.isInClearTextBlock()&&(a=this.toBB(a).replace(/\n/g,"<br/>").replace(/\s{3}/g,'<span class="wbbtab"></span>'));a=a.replace(/\t/g,'<span class="wbbtab"></span>');this.selectRange(this.lastRange);this.insertAtCursor(a,!1);this.$pasteBlock=this.lastRange=!1},this),1),this.selectNode(this.$pasteBlock[0])),!0},this));this.$body.bind("keydown",
b.proxy(function(a){13==a.which&&!this.isContain(this.getSelectNode(),"li")&&(a.preventDefault&&a.preventDefault(),this.checkForLastBR(this.getSelectNode()),this.insertAtCursor("<br/>",!1))},this));!0===this.options.tabInsert&&this.$body.bind("keydown",b.proxy(this.pressTab,this));this.$body.bind("mouseup keyup",b.proxy(this.updateUI,this));this.$body.bind("mousedown",b.proxy(function(a){this.clearLastRange();this.checkForLastBR(a.target)},this));!0===this.options.traceTextarea&&(b(document).bind("mousedown",
b.proxy(this.traceTextareaEvent,this)),this.$txtArea.val(""));!0===this.options.hotkeys&&this.$body.bind("keydown",b.proxy(this.presskey,this));!0===this.options.smileConversion&&this.$body.bind("keyup",b.proxy(this.smileConversion,this));this.inited=!0;!0===this.options.autoresize&&(this.$bresize=b(this.elFromString('<div class="bottom-resize-line"></div>')).appendTo(this.$editor).wdrag({scope:this,axisY:!0,height:a}))}this.$txtArea.bind("mouseup keyup",b.proxy(function(){clearTimeout(this.uitimer);
this.uitimer=setTimeout(b.proxy(this.updateUI,this),100)},this));!0===this.options.hotkeys&&b(document).bind("keydown",b.proxy(this.presskey,this))},buildToolbar:function(){if(!1===this.options.toolbar)return!1;this.$toolbar=b("<div>").addClass("wysibb-toolbar").prependTo(this.$editor);var a;b.each(this.options.buttons,b.proxy(function(c,e){var f=this.options.allButtons[e];if(0==c||"|"==e||"-"==e)"-"==e&&this.$toolbar.append("<div>"),a=b('<div class="wysibb-toolbar-container">').appendTo(this.$toolbar);
f&&("colorpicker"==f.type?this.buildColorpicker(a,e,f):"table"==f.type?this.buildTablepicker(a,e,f):"select"==f.type?this.buildSelect(a,e,f):"smilebox"==f.type?this.buildSmilebox(a,e,f):this.buildButton(a,e,f))},this));this.$toolbar.find(".btn-tooltip").hover(function(){b(this).parent().css("overflow","hidden")},function(){b(this).parent().css("overflow","visible")});var c=b(document.createElement("div")).addClass("wysibb-toolbar-container modeSwitch").html('<div class="wysibb-toolbar-btn mswitch" unselectable="on"><span class="btn-inner modesw" unselectable="on">[BBcode]</span></div>').appendTo(this.$toolbar);
!0==this.options.bbmode&&c.children(".wysibb-toolbar-btn").addClass("on");!1===this.options.onlyBBmode&&c.children(".wysibb-toolbar-btn").click(b.proxy(function(a){b(a.currentTarget).toggleClass("on");this.modeSwitch()},this));b.support.htmlSerialize&&this.$toolbar.find("*").attr("unselectable","on")},buildButton:function(a,c,d){"object"!=typeof a&&(a=this.$toolbar);var e=d.buttonHTML?b(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',
{text:d.buttonText.replace(/</g,"&lt;")}),f=!0===this.options.hotkeys&&!0===this.options.showHotkeys&&d.hotkey?' <span class="tthotkey">['+d.hotkey+"]</span>":"";a=b('<div class="wysibb-toolbar-btn wbb-'+c+'">').appendTo(a).append(e).append(this.strf('<span class="btn-tooltip">{title}<ins/>{hotkey}</span>',{title:d.title,hotkey:f}));this.controllers.push(a);a.bind("queryState",b.proxy(function(a){this.queryState(c)?b(a.currentTarget).addClass("on"):b(a.currentTarget).removeClass("on")},this));a.mousedown(b.proxy(function(a){a.preventDefault();
this.execCommand(c,d.exvalue||!1);b(a.currentTarget).trigger("queryState")},this))},buildColorpicker:function(a,c,d){var e=b('<div class="wysibb-toolbar-btn wbb-dropdown wbb-cp">').appendTo(a).append('<div class="ve-tlb-colorpick"><span class="fonticon">\ue010</span><span class="cp-line"></span></div><ins class="fonticon ar">\ue011</ins>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title})),f=e.find(".cp-line");a=b('<div class="wbb-list">').appendTo(e);a.append('<div class="nc">'+
CURLANG.auto+"</div>");d=d.colors?d.colors.split(","):[];for(c=0;c<d.length;c++)d[c]=b.trim(d[c]),"-"==d[c]?a.append('<span class="pl"></span>'):a.append(this.strf('<div class="sc" style="background:{color}" title="{color}"></div>',{color:d[c]}));var g=b(document.body).css("color");this.controllers.push(e);e.bind("queryState",b.proxy(function(a){f.css("background-color",g);if(a=this.queryState("fontcolor",!0))f.css("background-color",this.options.bbmode?a.color:a),e.find(".ve-tlb-colorpick span.fonticon").css("color",
this.options.bbmode?a.color:a)},this));e.mousedown(b.proxy(function(a){a.preventDefault();this.dropdownclick(".wbb-cp",".wbb-list",a)},this));e.find(".sc").mousedown(b.proxy(function(a){a.preventDefault();this.selectLastRange();a=b(a.currentTarget).attr("title");this.execCommand("fontcolor",a);e.trigger("queryState")},this));e.find(".nc").mousedown(b.proxy(function(a){a.preventDefault();this.selectLastRange();this.execCommand("fontcolor",g);e.trigger("queryState")},this));e.mousedown(function(a){a.preventDefault&&
a.preventDefault()})},buildTablepicker:function(a,c,d){a=b('<div class="wysibb-toolbar-btn wbb-dropdown wbb-tbl">').appendTo(a).append('<span class="btn-inner fonticon ve-tlb-table1">\ue00e</span><ins class="fonticon ar">\ue011</ins>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title}));c=b('<div class="wbb-list">').appendTo(a);var e=d.rows||10,f=d.cols||10,g=e*f;c.css("width",f*d.cellwidth+2+"px").css("height",e*d.cellwidth+2+"px");for(var h=1;h<=f;h++)for(var k=1;k<=
e;k++){var l='<div class="tbl-sel" style="width:'+h*d.cellwidth+"px;height:"+k*d.cellwidth+"px;z-index:"+--g+'" title="'+k+","+h+'"></div>';c.append(l)}a.find(".tbl-sel").mousedown(b.proxy(function(a){a.preventDefault();a=b(a.currentTarget).attr("title").split(",");for(var c=this.options.bbmode?"[table]":'<table class="wbb-table" cellspacing="5" cellpadding="0">',d=1;d<=a[0];d++){for(var c=c+(this.options.bbmode?" [tr]\n":"<tr>"),e=1;e<=a[1];e++)c+=this.options.bbmode?"  [td][/td]\n":"<td>\ufeff</td>";
c+=this.options.bbmode?"[/tr]\n":"</tr>"}c+=this.options.bbmode?"[/table]":"</table>";this.insertAtCursor(c)},this));a.mousedown(b.proxy(function(a){a.preventDefault();this.dropdownclick(".wbb-tbl",".wbb-list",a)},this))},buildSelect:function(a,c,d){var e=b('<div class="wysibb-toolbar-btn wbb-select wbb-'+c+'">').appendTo(a).append(this.strf('<span class="val">{title}</span><ins class="fonticon sar">\ue012</ins>',d)).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title}));
a=b('<div class="wbb-list">').appendTo(e);for(var f=e.find("span.val"),g=b.isArray(d.options)?d.options:d.options.split(","),h=0;h<g.length;h++){var k=g[h];if("string"==typeof k){var l=this.options.allButtons[k];l&&(l.html?b("<span>").addClass("option").attr("oid",k).attr("cmdvalue",l.exvalue).appendTo(a).append(this.strf(l.html,{seltext:l.title})):a.append(this.strf('<span class="option" oid="'+k+'" cmdvalue="'+l.exvalue+'">{title}</span>',l)))}else l={seltext:k.title},l[d.valueBBname]=k.exvalue,
b("<span>").addClass("option").attr("oid",c).attr("cmdvalue",k.exvalue).appendTo(a).append(this.strf(d.html,l))}this.controllers.push(e);e.bind("queryState",b.proxy(function(a){f.text(d.title);e.find(".option.selected").removeClass("selected");e.find(".option").each(b.proxy(function(a,c){var d=b(c),e=this.queryState(d.attr("oid"),!0),g=d.attr("cmdvalue");if(g&&e==d.attr("cmdvalue")||!g&&e)return f.text(d.text()),d.addClass("selected"),!1},this))},this));e.mousedown(b.proxy(function(a){a.preventDefault();
this.dropdownclick(".wbb-select",".wbb-list",a)},this));e.find(".option").mousedown(b.proxy(function(a){a.preventDefault();var c=b(a.currentTarget).attr("oid"),d=b(a.currentTarget).attr("cmdvalue");this.execCommand(c,this.options.allButtons[c].exvalue||d||!1);b(a.currentTarget).trigger("queryState")},this))},buildSmilebox:function(a,c,d){if(this.options.smileList&&0<this.options.smileList.length){var e=b(this.strf(d.buttonHTML,d)).addClass("btn-inner");a=b('<div class="wysibb-toolbar-btn wbb-smilebox wbb-'+
c+'">').appendTo(a).append(e).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title}));var f=b('<div class="wbb-list">').appendTo(a);b.isArray(this.options.smileList)&&b.each(this.options.smileList,b.proxy(function(a,c){b("<span>").addClass("smile").appendTo(f).append(b(this.strf(c.img,this.options)).attr("title",c.title))},this));a.mousedown(b.proxy(function(a){a.preventDefault();this.dropdownclick(".wbb-smilebox",".wbb-list",a)},this));a.find(".smile").mousedown(b.proxy(function(a){a.preventDefault();
this.insertAtCursor(this.options.bbmode?this.toBB(b(a.currentTarget).html()):b(b(a.currentTarget).html()))},this))}},updateUI:function(a){(!a||8<=a.which&&46>=a.which||90<a.which||"mouseup"==a.type)&&b.each(this.controllers,b.proxy(function(a,b){b.trigger("queryState")},this));this.disNonActiveButtons()},initModal:function(){this.$modal=b("#wbbmodal");0==this.$modal.size()&&(b.log("Init modal"),this.$modal=b("<div>").attr("id","wbbmodal").prependTo(document.body).html('<div class="wbbm"><div class="wbbm-title"><span class="wbbm-title-text"></span><span class="wbbclose" title="'+
CURLANG.close+'">\u00d7</span></div><div class="wbbm-content"></div><div class="wbbm-bottom"><button id="wbbm-submit" class="wbb-button">'+CURLANG.save+'</button><button id="wbbm-cancel" class="wbb-cancel-button">'+CURLANG.cancel+'</button><button id="wbbm-remove" class="wbb-remove-button">'+CURLANG.remove+"</button></div></div>").hide(),this.$modal.find("#wbbm-cancel,.wbbclose").click(b.proxy(this.closeModal,this)),this.$modal.bind("click",b.proxy(function(a){0==b(a.target).parents(".wbbm").size()&&
this.closeModal()},this)),b(document).bind("keydown",b.proxy(this.escModal,this)))},initHotkeys:function(){b.log("initHotkeys");this.hotkeys=[];b.each(this.options.allButtons,b.proxy(function(a,c){if(c.hotkey){var d=c.hotkey.split("+");if(d&&2<=d.length){var e=0,f=d.pop();b.each(d,function(a,c){switch(b.trim(c.toLowerCase())){case "ctrl":e+=1;break;case "shift":e+=4;break;case "alt":e+=7}});0<e&&(this.hotkeys["m"+e]||(this.hotkeys["m"+e]=[]),this.hotkeys["m"+e]["k"+("0123456789       abcdefghijklmnopqrstuvwxyz".indexOf(f)+
48)]=a)}}},this))},presskey:function(a){if(!0==a.ctrlKey||!0==a.shiftKey||!0==a.altKey){var b=(!0==a.ctrlKey?1:0)+(!0==a.shiftKey?4:0)+(!0==a.altKey?7:0);if(this.hotkeys["m"+b]&&this.hotkeys["m"+b]["k"+a.which])return this.execCommand(this.hotkeys["m"+b]["k"+a.which],!1),a.preventDefault(),!1}},execCommand:function(a,c){b.log("execCommand: "+a);var d=this.options.allButtons[a];if(!0!==d.en)return!1;var e=this.queryState(a,c),f=this.isInClearTextBlock();f&&f!=a||(d.excmd?this.options.bbmode?(b.log("Native command in bbmode: "+
a),e&&!0!=d.subInsert?this.wbbRemoveCallback(a,c):(e={},d.valueBBname&&c&&(e[d.valueBBname]=c),this.insertAtCursor(this.getBBCodeByCommand(a,e)))):this.execNativeCommand(d.excmd,c||!1):d.cmd?d.cmd.call(this,a,c,e):this.wbbExecCommand.call(this,a,c,e),this.updateUI())},queryState:function(a,c){var d=this.options.allButtons[a];if(!0!==d.en)return!1;if(this.options.bbmode){if(d.bbSelector)for(var e=0;e<d.bbSelector.length;e++){var f=this.isBBContain(d.bbSelector[e]);if(f)return this.getParams(f,d.bbSelector[e],
f[1])}return!1}if(d.excmd)if(c)try{return e=(document.queryCommandValue(d.excmd)+"").replace(/\'/g,""),"foreColor"==d.excmd&&(e=this.rgbToHex(e)),e}catch(g){return!1}else try{return document.queryCommandState(d.excmd)}catch(h){return!1}else{if(b.isArray(d.rootSelector))for(e=0;e<d.rootSelector.length;e++)if(f=this.isContain(this.getSelectNode(),d.rootSelector[e]))return this.getParams(f,d.rootSelector[e]);return!1}},wbbExecCommand:function(a,c,d){b.log("wbbExecCommand");var e=this.options.allButtons[a];
if(e)if(e.modal)b.isFunction(e.modal)?e.modal.call(this,a,e.modal,d):this.showModal.call(this,a,e.modal,d);else if(d&&!0!=e.subInsert)this.wbbRemoveCallback(a);else{if(e.groupkey&&(d=this.options.groups[e.groupkey])){var f=this.getSelectNode();b.each(d,b.proxy(function(a,c){var d=this.isContain(f,c);if(d){var e=b("<span>").html(d.innerHTML),n=this.setUID(e);b(d).replaceWith(e);this.selectNode(this.$editor.find("#"+n)[0]);return!1}},this))}this.wbbInsertCallback(a,c)}},wbbInsertCallback:function(a,
c){"object"!=typeof c&&(c={});b.log("wbbInsertCallback: "+a);var d=this.getCodeByCommand(a,c);this.insertAtCursor(d);this.seltextID&&-1!=d.indexOf(this.seltextID)&&(d=this.$body.find("#"+this.seltextID)[0],this.selectNode(d),b(d).removeAttr("id"),this.seltextID=!1)},wbbRemoveCallback:function(a,c){b.log("wbbRemoveCallback: "+a);var d=this.options.allButtons[a];if(this.options.bbmode){this.getCursorPosBB();var e=0;b.each(d.bbSelector,b.proxy(function(a,d){var f=d.match(/\{[\s\S]+?\}/g);b.each(f,function(a,
b){if("{seltext}"==b.toLowerCase())return e=a,!1});if(f=this.isBBContain(d))return this.txtArea.value=this.txtArea.value.substr(0,f[1])+this.txtArea.value.substr(f[1],this.txtArea.value.length-f[1]).replace(f[0][0],!0===c?"":f[0][e+1]),this.setCursorPosBB(f[1]),!1},this))}else{var f=this.getSelectNode();b.each(d.rootSelector,b.proxy(function(e,h){var k=this.isContain(f,h);if(!k)return!0;var l=b(k),n=this.options.rules[h][0][1];if(l.is("span[wbb]")||!l.is("span,font"))!0===c?l.remove():(n&&n.seltext&&
n.seltext.sel?(n=l.find(n.seltext.sel).html(),!0===d.onlyClearText&&(n=this.getHTML(n,!0,!0),n=n.replace(/\&#123;/g,"{").replace(/\&#125;/g,"}"))):(n=l.html(),!0===d.onlyClearText&&(n=this.getHTML(n,!0),n=n.replace(/\&lt;/g,"<").replace(/\&#123;/g,"{").replace(/\&#125;/g,"}"))),l.replaceWith(n));else{var m=this.getRange(),n=this.getSelectText();this.getSelectNode();b.log("selHTML: "+n);var n=""==n?"\ufeff":this.clearFromSubInsert(n,a),n=this.elFromString(n),p=window.getSelection?m.cloneRange():this.body.createTextRange(),
q=window.getSelection?m.cloneRange():this.body.createTextRange();window.getSelection?(this.insertAtCursor('<span id="wbbdivide"></span>'),m=l.find("span#wbbdivide").get(0),p.setStart(k.firstChild,0),p.setEndBefore(m),q.setStartAfter(m),q.setEndAfter(k.lastChild)):(p.moveToElementText(k),q.moveToElementText(k),p.setEndPoint("EndToStart",m),q.setEndPoint("StartToEnd",m));k=this.getSelectText(!1,p);q=this.getSelectText(!1,q);""!=q&&(q=l.clone().html(q),l.after(q));!0!==c&&l.after(n);window.getSelection?
(l.html(k),!0!==c&&this.selectNode(n)):l.replaceWith(k)}return!1},this))}},execNativeCommand:function(a,c){this.body.focus();if("insertHTML"==a&&!window.getSelection){var d=this.lastRange?this.lastRange:document.selection.createRange();d.pasteHTML(c);var e=b("<div>").html(c).text(),f=e.indexOf("\ufeff");-1<f&&(d.moveStart("character",-1*(e.length-f)),d.select());this.lastRange=!1}else"insertHTML"==a?(d=this.getSelection(),e=this.elFromString(c),f=this.lastRange?this.lastRange:this.getRange(),f.deleteContents(),
f.insertNode(e),f.collapse(!1),d.removeAllRanges(),d.addRange(f)):("undefined"==typeof c&&(c=!1),this.lastRange&&(b.log("Last range select"),this.selectLastRange()),document.execCommand(a,!1,c),"fontSize"==a&&b(".wysibb-body").find("font").each(function(){var a=0;switch(b(this).attr("size")){case "1":a=25;break;case "2":a=50;break;case "3":a=100;break;case "4":a=120;break;case "5":a=150;break;case "6":a=200;break;case "7":a=300}0<a&&(b(this).removeAttr("size"),b(this).attr("style","font-size: "+a+
"%;"))}))},getCodeByCommand:function(a,b){return this.options.bbmode?this.getBBCodeByCommand(a,b):this.getHTMLByCommand(a,b)},getBBCodeByCommand:function(a,c){if(!this.options.allButtons[a])return"";"undefined"==typeof c&&(c={});c=this.keysToLower(c);c.seltext||(c.seltext=this.getSelectText(!0));var d=this.options.allButtons[a].bbcode,d=d.replace(/\{(.*?)(\[.*?\])*\}/g,function(a,b,d){if(d){var e;d&&(e=RegExp(d+"+","i"));if("undefined"!=typeof c[b.toLowerCase()]&&null===c[b.toLowerCase()].toString().match(e))return""}return"undefined"==
typeof c[b.toLowerCase()]?"":c[b.toLowerCase()]}),e=null,f=0;if(this.options.allButtons[a].transform){var g=[];b.each(this.options.allButtons[a].transform,function(a,b){g.push(b)});g=this.sortArray(g,-1);b.each(g,function(a,b){var d=!0,g=0,m={};b=b.replace(/\{(.*?)(\[.*?\])*\}/g,function(a,b,e){var f;b=b.toLowerCase();e&&(f=RegExp(e+"+","i"));if("undefined"==typeof c[b.toLowerCase()]||e&&null===c[b.toLowerCase()].toString().match(f))d=!1;"undefined"!=typeof c[b]&&!m[b]&&(m[b]=1,g++);return"undefined"==
typeof c[b.toLowerCase()]?"":c[b.toLowerCase()]});d&&g>f&&(e=b,f=g)})}return e||d},getHTMLByCommand:function(a,c){if(!this.options.allButtons[a])return"";c=this.keysToLower(c);"undefined"==typeof c&&(c={});c.seltext||(c.seltext=this.getSelectText(!1),""==c.seltext?c.seltext="\ufeff":(c.seltext=this.clearFromSubInsert(c.seltext,a),!0===this.options.allButtons[a].onlyClearText&&(c.seltext=this.toBB(c.seltext).replace(/\</g,"&lt;").replace(/\n/g,"<br/>").replace(/\s{3}/g,'<span class="wbbtab"></span>'))));
var d="";this.seltextID="wbbid_"+ ++this.lastid;"link"!=a&&"img"!=a?c.seltext='<span id="'+this.seltextID+'">'+c.seltext+"</span>":d='<span id="'+this.seltextID+'">\ufeff</span>';var e=this.options.allButtons[a].html,e=e.replace(/\{(.*?)(\[.*?\])*\}/g,function(a,b,d){return d&&(a=RegExp(d+"+","i"),"undefined"!=typeof c[b.toLowerCase()]&&null===c[b.toLowerCase()].toString().match(a))?"":"undefined"==typeof c[b.toLowerCase()]?"":c[b.toLowerCase()]}),f=null,g=0;if(this.options.allButtons[a].transform){var h=
[];b.each(this.options.allButtons[a].transform,function(a,b){h.push(a)});h=this.sortArray(h,-1);b.each(h,function(a,b){var d=!0,e=0,h={};b=b.replace(/\{(.*?)(\[.*?\])*\}/g,function(a,b,f){var g;b=b.toLowerCase();f&&(g=RegExp(f+"+","i"));if("undefined"==typeof c[b]||f&&null===c[b].toString().match(g))d=!1;"undefined"!=typeof c[b]&&!h[b]&&(h[b]=1,e++);return"undefined"==typeof c[b]?"":c[b]});d&&e>g&&(f=b,g=e)})}return(f||e)+d},getSelection:function(){if(window.getSelection)return window.getSelection();
if(document.selection)return document.selection.createRange()},getSelectText:function(a,c){if(a)return this.txtArea.focus(),"selectionStart"in this.txtArea?this.txtArea.value.substr(this.txtArea.selectionStart,this.txtArea.selectionEnd-this.txtArea.selectionStart):document.selection.createRange().text;this.body.focus();c||(c=this.getRange());if(window.getSelection){if(c)return b("<div>").append(c.cloneContents()).html()}else return c.htmlText;return""},getRange:function(){if(window.getSelection){var a=
this.getSelection();if(a.getRangeAt&&0<a.rangeCount)return a.getRangeAt(0);if(a.anchorNode){var b=document.createRange();b.setStart(a.anchorNode,a.anchorOffset);b.setEnd(a.focusNode,a.focusOffset);return b}}else return document.selection.createRange()},insertAtCursor:function(a,c){"string"!=typeof a&&(a=b("<div>").append(a).html());if(this.options.bbmode&&"undefined"==typeof c||!0===c){var d=a.replace(/.*(\[\/\S+?\])$/,"$1"),d=this.getCursorPosBB()+(-1!=a.indexOf(d)&&a.match(/\[.*\]/)?a.indexOf(d):
a.length);if(document.selection)this.txtArea.focus(),this.getSelection().text=a;else if(this.txtArea.selectionStart||"0"==this.txtArea.selectionStart)this.txtArea.value=this.txtArea.value.substring(0,this.txtArea.selectionStart)+a+this.txtArea.value.substring(this.txtArea.selectionEnd,this.txtArea.value.length);0>d&&(d=0);this.setCursorPosBB(d)}else this.execNativeCommand("insertHTML",a),d=this.getSelectNode(),b(d).closest("table,tr,td")||this.splitPrevNext(d)},getSelectNode:function(a){this.body.focus();
a||(a=this.getRange());return!a?this.$body:window.getSelection?a.commonAncestorContainer:a.parentElement()},getCursorPosBB:function(){var a=0;if("selectionStart"in this.txtArea)a=this.txtArea.selectionStart;else{this.txtArea.focus();var a=this.getRange(),b=document.body.createTextRange();b.moveToElementText(this.txtArea);b.setEndPoint("EndToStart",a);a=b.text.length}return a},setCursorPosBB:function(a){if(this.options.bbmode)if(window.getSelection)this.txtArea.selectionStart=a,this.txtArea.selectionEnd=
a;else{var b=this.txtArea.createTextRange();b.collapse(!0);b.move("character",a);b.select()}},selectNode:function(a,b){b||(b=this.getRange());if(b)if(window.getSelection){var d=this.getSelection();b.selectNodeContents(a);d.removeAllRanges();d.addRange(b)}else b.moveToElementText(a),b.select()},selectRange:function(a){if(a)if(window.getSelection){var b=this.getSelection();b.removeAllRanges();b.addRange(a)}else a.select()},cloneRange:function(a){if(a)return window.getSelection?a.cloneRange():a.duplicate()},
getRangeClone:function(){return this.cloneRange(this.getRange())},saveRange:function(){this.setBodyFocus();this.lastRange=this.getRangeClone()},selectLastRange:function(){this.lastRange&&(this.body.focus(),this.selectRange(this.lastRange),this.lastRange=!1)},setBodyFocus:function(){b.log("Set focus to WysiBB editor");this.options.bbmode?this.$txtArea.is(":focus")||this.$txtArea.focus():this.$body.is(":focus")||this.$body.focus()},clearLastRange:function(){this.lastRange=!1},filterByNode:function(a){var c=
b(a),d=c.get(0).tagName.toLowerCase();a=this.getAttributeList(c.get(0));b.each(a,b.proxy(function(a,f){var g=c.attr(f);"_"==f.substr(0,1)&&(f=f.substr(1,f.length));if(g&&!g.match(/\{.*?\}/))"style"==f?(g=c.attr(f),g=g.split(";"),b.each(g,function(a,c){c&&0<c.length&&(d+="["+f+'*="'+b.trim(c)+'"]')})):d+="["+f+'="'+g+'"]';else if(g&&"style"==f){var h=g.substr(0,g.indexOf("{"));h&&""!=h&&(g=g.substr(0,g.indexOf("{")),g=g.split(";"),b.each(g,function(a,b){d+="["+f+'*="'+b+'"]'}))}else d+="["+f+"]"},
this));0<c.parent().children(d).index(c)&&(d+=":eq("+c.index()+")");return d},relFilterByNode:function(a,c){var d="";for(b.each(this.options.attrWrap,function(a,b){c=c.replace("["+b,"[_"+b)});a&&"BODY"!=a.tagName&&!b(a).is(c);)d=this.filterByNode(a)+" "+d,a&&(a=a.parentNode);return d},getRegexpReplace:function(a,b){return a=a.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,"\\$1").replace(/\s+/g,"\\s+").replace(b.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,"\\$1"),"(.+)").replace(/\{\S+?\}/g,".*")},getBBCode:function(){if(!this.options.rules||
this.options.bbmode)return this.$txtArea.val();this.clearEmpty();this.removeLastBodyBR();return this.toBB(this.$body.html())},toBB:function(a){if(!a)return"";var c="string"==typeof a?b("<span>").html(a):b(a);c.find("div,blockquote,p").each(function(){3!=this.nodeType&&(this.lastChild&&"BR"==this.lastChild.tagName)&&b(this.lastChild).remove()});c.is("div,blockquote,p")&&(3!=c[0].nodeType&&c[0].lastChild&&"BR"==c[0].lastChild.tagName)&&b(c[0].lastChild).remove();c.find("ul > br, table > br, tr > br").remove();
var d="";b.each(this.options.srules,b.proxy(function(a,b){c.find(a).replaceWith(b[0])},this));c.contents().each(b.proxy(function(a,c){var g=b(c);if(3===c.nodeType)d+=c.data.replace(/\n+/,"").replace(/\t/g,"   ");else{for(var h=0;h<this.rsellist.length;h++){var k=this.rsellist[h];if(g&&g.is(k)){k=this.options.rules[k];for(a=0;a<k.length;a++){var l=k[a][0],n=k[a][1],m=!1,p=!1;g.is("br")||(l=l.replace(/\n/g,"<br>"));l=l.replace(/\{(.*?)(\[.*?\])*\}/g,b.proxy(function(a,d,e){a=n[d.toLowerCase()];"undefined"==
typeof a&&(b.log("Param: {"+d+"} not found in HTML representation."),m=!0);e=a.sel?b(c).find(a.sel):b(c);if(a.attr&&!e.attr(a.attr))return m=!0,d;var h=a.attr?e.attr(a.attr):e.html();if("undefined"==typeof h||null==h)return m=!0,d;(d=a.rgx)&&("style"==a.attr&&";"!=d.substr(d.length-1,1))&&(d+=";");"style"==a.attr&&(h&&";"!=h.substr(h.length-1,1))&&(h+=";");if(d=d?RegExp(d,""):!1)h.match(d)?(d=h.match(d))&&2==d.length&&(h=d[1]):h="";if(a.attr&&!1===m)if("style"==a.attr){p=!0;var l="",k=a.rgx.replace(/^\.\*\?/,
"").replace(/\.\*$/,"").replace(/;$/,"");b(e.attr("style").split(";")).each(function(a,b){b&&""!=b&&(b.match(k)||(l+=b+";"))});""==l?e.removeAttr("style"):e.attr("style",l)}else!1===a.rgx&&(p=!0,e.removeAttr(a.attr));g.is("table,tr,td,font")&&(p=!0);return h||""},this));if(!m)if(g.is("img,br,hr")){d+=l;g=null;break}else if(p&&!g.attr("notkeep"))g.is("table,tr,td")?(l=this.fixTableTransform(l),d+=this.toBB(b("<span>").html(l)),g=null):b.support.htmlSerialize?g.empty().append(b("<span>").html(l)):g.empty().html("<span>"+
l+"</span>");else{g.is("iframe")?d+=l:(g.empty().html(l),d+=this.toBB(g),g=null);break}}}}if(!g||g.is("iframe,img"))return!0;d+=this.toBB(g)}},this));return d},getHTML:function(a,c,d){if(!this.options.bbmode&&!c)return this.$body.html();d||(a=a.replace(/</g,"&lt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;"));a=a.replace(/\[code\]([\s\S]*?)\[\/code\]/g,function(a){a=a.substr(6,a.length-6-7).replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");return"[code]"+a+"[/code]"});b.each(this.options.btnlist,
b.proxy(function(c,d){if("|"!=d&&"-"!=d){if(!this.options.allButtons[d]||!this.options.allButtons[d].transform)return!0;b.each(this.options.allButtons[d].transform,b.proxy(function(c,d){c=c.replace(/\n/g,"");var e=[];d=d.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1");d=d.replace(/\{(.*?)(\\\[.*?\\\])*\}/gi,b.proxy(function(a,b,c){e.push(b);return c?(c=c.replace(/\\/g,""),"("+c+"*?)"):"([\\s\\S]*?)"},this));for(var f;null!=(f=RegExp(d,"mgi").exec(a));)if(f){var n={};b.each(e,b.proxy(function(a,
b){n[b]=f[a+1]},this));var m=c,m=m.replace(/\{(.*?)(\[.*?\])\}/g,"{$1}"),m=this.strf(m,n);a=a.replace(f[0],m)}},this))}},this));b.each(this.options.systr,function(b,c){c=c.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1").replace(" ","\\s");a=a.replace(RegExp(c,"g"),b)});c=b(this.elFromString("<div>"+a+"</div>"));this.getHTMLSmiles(c);return c.html()},getHTMLSmiles:function(a){b(a).contents().filter(function(){return 3==this.nodeType}).each(b.proxy(this.smileRPL,this))},smileRPL:function(a,c){var d=
c.data;b.each(this.options.smileList,b.proxy(function(a,f){var g=d.indexOf(f.bbcode);if(-1!=g){var h=d.substring(g+f.bbcode.length,d.length),h=document.createTextNode(h);c.data=d=c.data.substr(0,g);b(c).after(h).after(this.strf(f.img,this.options));this.getHTMLSmiles(c.parentNode);return!1}this.getHTMLSmiles(c)},this))},setUID:function(a,c){var d="wbbid_"+ ++this.lastid;a&&b(a).attr(c||"id",d);return d},keysToLower:function(a){b.each(a,function(b,d){b!=b.toLowerCase()&&(delete a[b],a[b.toLowerCase()]=
d)});return a},strf:function(a,c){c=this.keysToLower(b.extend({},c));return a.replace(/\{([\w\.]*)\}/g,function(a,e){e=e.toLowerCase();var f=e.split("."),g=c[f.shift().toLowerCase()];b.each(f,function(){g=g[this]});return null===g||void 0===g?"":g})},elFromString:function(a){if(-1!=a.indexOf("<")&&-1!=a.indexOf(">")){var c=document.createElement("SPAN");b(c).html(a);this.setUID(c,"wbb");return 1<b(c).contents().size()?c:c.firstChild}return document.createTextNode(a)},isContain:function(a,c){for(;a&&
!b(a).hasClass("wysibb");){if(b(a).is(c))return a;if(a)a=a.parentNode;else return null}},isBBContain:function(a){var b=this.getCursorPosBB();a=this.prepareRGX(a);a=RegExp(a,"g");for(var d,e=0;null!=(d=a.exec(this.txtArea.value));){e=this.txtArea.value.indexOf(d[0],e);if(b>e&&b<e+d[0].length)return[d,e];e+=1}},prepareRGX:function(a){return a.replace(/(\[|\]|\)|\(|\.|\*|\?|\:|\||\\)/g,"\\$1").replace(/\{.*?\}/g,"([\\s\\S]*?)")},checkForLastBR:function(a){3==a.nodeType&&(a=a.parentNode);a=b(a);a.is("span[id*='wbbid']")&&
(a=a.parent());if(!1===this.options.bbmode&&a.is("div,blockquote,code")&&0<a.contents().size()){var c=a[0].lastChild;(!c||c&&"BR"!=c.tagName)&&a.append("<br/>")}0<this.$body.contents().size()&&"BR"!=this.body.lastChild.tagName&&this.$body.append("<br/>")},getAttributeList:function(a){var c=[];b.each(a.attributes,function(a,b){b.specified&&c.push(b.name)});return c},clearFromSubInsert:function(a,c){if(this.options.allButtons[c]&&this.options.allButtons[c].rootSelector){var d=b("<div>").html(a);b.each(this.options.allButtons[c].rootSelector,
b.proxy(function(a,c){var g=!1;"undefined"!=typeof this.options.rules[c][0][1].seltext&&(g=this.options.rules[c][0][1].seltext.sel);var h=!0;d.find("*").each(function(){b(this).is(c)&&(g&&g.sel?b(this).replaceWith(b(this).find(g.sel.toLowerCase()).html()):b(this).replaceWith(b(this).html()),h=!1)});return h},this));return d.html()}return a},splitPrevNext:function(a){3==a.nodeType&&(a=a.parentNode);var c=this.filterByNode(a).replace(/\:eq.*$/g,"");b(a.nextSibling).is(c)&&(b(a).append(b(a.nextSibling).html()),
b(a.nextSibling).remove());b(a.previousSibling).is(c)&&(b(a).prepend(b(a.previousSibling).html()),b(a.previousSibling).remove())},modeSwitch:function(){this.options.bbmode?(this.$body.html(this.getHTML(this.$txtArea.val())),this.$txtArea.hide().removeAttr("wbbsync").val(""),this.$body.css("min-height",this.$txtArea.height()).show().focus()):(this.$txtArea.val(this.getBBCode()).css("min-height",this.$body.height()),this.$body.hide(),this.$txtArea.show().focus());this.options.bbmode=!this.options.bbmode},
clearEmpty:function(){function a(){if(!b(this).is("span,font,a,b,i,u,s"))return!1;if(!b(this).hasClass("wbbtab")&&0==b.trim(b(this).html()).length||0<b(this).children().size()&&(b(this).children().filter(a).remove(),0==b(this).html().length&&"BODY"!=this.tagName))return!0}this.$body.children().filter(a).remove()},dropdownclick:function(a,c,d){var e=b(d.currentTarget).closest(a);e.hasClass("dis")||(e.attr("wbbshow")?(e.removeAttr("wbbshow"),b(document).unbind("mousedown",this.dropdownhandler),document&&
b(document).unbind("mousedown",this.dropdownhandler),this.lastRange=!1):(this.saveRange(),this.$editor.find("*[wbbshow]").each(function(a,c){b(c).removeClass("on").find(b(c).attr("wbbshow")).hide().end().removeAttr("wbbshow")}),e.attr("wbbshow",c),b(document.body).bind("mousedown",b.proxy(function(b){this.dropdownhandler(e,a,c,b)},this)),this.$body&&this.$body.bind("mousedown",b.proxy(function(b){this.dropdownhandler(e,a,c,b)},this))),e.find(c).toggle(),e.toggleClass("on"))},dropdownhandler:function(a,
c,d,e){0==b(e.target).parents(c).size()&&(a.removeClass("on").find(d).hide(),b(document).unbind("mousedown",this.dropdownhandler),this.$body&&this.$body.unbind("mousedown",this.dropdownhandler))},rgbToHex:function(a){if("#"==a.substr(0,1))return a;if(-1==a.indexOf("rgb"))return a=parseInt(a),"#"+((a&255)<<16|a&65280|(a&16711680)>>>16).toString(16);a=/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(a);return"#"+this.dec2hex(parseInt(a[2]))+this.dec2hex(parseInt(a[3]))+this.dec2hex(parseInt(a[4]))},dec2hex:function(a){return 15<
a?a.toString(16):"0"+a.toString(16)},sync:function(){this.options.bbmode?this.$body.html(this.getHTML(this.txtArea.value,!0)):this.$txtArea.attr("wbbsync",1).val(this.getBBCode())},clearPaste:function(a){var c=b(a);b.each(this.options.rules,b.proxy(function(a,e){var f=c.find(a).attr("wbbkeep",1);0<f.size()&&b.each(e[0][1],function(a,b){b.sel&&f.find(b.sel).attr("wbbkeep",1)})},this));c.find("*[wbbkeep!='1']").each(b.proxy(function(a,c){var f=b(c);f.is("div,p")&&(0==f.children().size()||"BR"!=c.lastChild.tagName)&&
f.after("<br/>")},this));c.find("*[wbbkeep]").removeAttr("wbbkeep").removeAttr("style");b.log(c.html());c.html(this.getHTML(this.toBB(c),!0));b.log(c.html())},sortArray:function(a,b){a.sort(function(a,e){return(a.length-e.length)*(b||1)});return a},smileFind:function(){if(this.options.smilefind){var a=b(this.options.smilefind).find("img[alt]");0<a.size()&&(this.options.smileList=[],a.each(b.proxy(function(a,d){var e=b(d);this.options.smileList.push({title:e.attr("title"),bbcode:e.attr("alt"),img:e.removeAttr("alt").removeAttr("title")[0].outerHTML})},
this)))}},destroy:function(){this.$editor.replaceWith(this.$txtArea);this.$txtArea.removeClass("wysibb-texarea").show();this.$modal.remove();this.$txtArea.data("wbb",null)},pressTab:function(a){a&&9==a.which&&(a.preventDefault&&a.preventDefault(),this.options.bbmode?this.insertAtCursor("   ",!1):this.insertAtCursor('<span class="wbbtab">\ufeff</span>',!1))},removeLastBodyBR:function(){this.body.lastChild&&(3!=this.body.lastChild.nodeType&&"BR"==this.body.lastChild.tagName)&&(this.body.removeChild(this.body.lastChild),
this.removeLastBodyBR())},traceTextareaEvent:function(a){0==b(a.target).closest("div.wysibb").size()&&(b(document.activeElement).is("div.wysibb-body")&&this.saveRange(),setTimeout(b.proxy(function(){var c=this.$txtArea.val();!1===this.options.bbmode&&(""!=c&&0==b(a.target).closest("div.wysibb").size()&&!this.$txtArea.attr("wbbsync"))&&(this.selectLastRange(),this.insertAtCursor(this.getHTML(c,!0)),this.$txtArea.val(""));b(document.activeElement).is("div.wysibb-body")&&(this.lastRange=!1)},this),100))},
txtAreaInitContent:function(){this.$body.html(this.getHTML(this.txtArea.value,!0))},getValidationRGX:function(a){return a.match(/\[\S+\]/)?a.replace(/.*(\\*\[\S+\]).*/,"$1"):""},smileConversion:function(){var a=this.getSelectNode();if(3==a.nodeType){var c=a.data;2<=c.length&&(!this.isInClearTextBlock(a)&&0==b(a).parents("a").size())&&b.each(this.options.srules,b.proxy(function(d,e){var f=e[0],g=c.indexOf(f);if(-1!=g){var f=c.substring(g+f.length,c.length),f=document.createTextNode(f),h=document.createElement("SPAN");
a.data=a.data.substr(0,g);b(a).after(f).after(h).after(this.strf(e[1],this.options));this.selectNode(h);return!1}},this))}},isInClearTextBlock:function(){if(this.cleartext){var a=!1;b.each(this.cleartext,b.proxy(function(b,d){if(this.queryState(d))return a=d,!1},this));return a}return!1},wrapAttrs:function(a){b.each(this.options.attrWrap,function(b,d){a=a.replace(d+'="',"_"+d+'="')});return a},unwrapAttrs:function(a){b.each(this.options.attrWrap,function(b,d){a=a.replace("_"+d+'="',d+'="')});return a},
disNonActiveButtons:function(){this.isInClearTextBlock()?this.$toolbar.find(".wysibb-toolbar-btn:not(.on,.mswitch)").addClass("dis"):this.$toolbar.find(".wysibb-toolbar-btn.dis").removeClass("dis")},showModal:function(a,c,d){b.log("showModal: "+a);this.saveRange();var e=this.$modal.find(".wbbm-content").html(""),f=this.$modal.find(".wbbm").removeClass("hastabs");this.$modal.find("span.wbbm-title-text").html(c.title);if(c.tabs&&1<c.tabs.length){f.addClass("hastabs");var g=b('<div class="wbbm-tablist">').appendTo(e).append("<ul>").children("ul");
b.each(c.tabs,b.proxy(function(a,b){0==a&&(b.on="on");g.append(this.strf("<li class=\"{on}\" onClick=\"$(this).parent().find('.on').removeClass('on');$(this).addClass('on');$(this).parents('.wbbm-content').find('.tab-cont').hide();$(this).parents('.wbbm-content').find('.tab"+a+"').show()\">{title}</li>",b))},this))}c.width&&f.css("width",c.width);var h=b('<div class="wbbm-cont">').appendTo(e);d?f.find("#wbbm-remove").show():f.find("#wbbm-remove").hide();b.each(c.tabs,b.proxy(function(a,c){var e=b("<div>").addClass("tab-cont tab"+
a).attr("tid",a).appendTo(h);0<a&&e.hide();c.html?e.html(this.strf(c.html,this.options)):b.each(c.input,b.proxy(function(a,c){c.value=d[c.param.toLowerCase()];if("seltext"==c.param.toLowerCase()&&(!c.value||""==c.value))c.value=this.getSelectText(this.options.bbmode);c.value&&(0==c.value.indexOf("<span id='wbbid")&&b(c.value).is("span[id*='wbbid']"))&&(c.value=b(c.value).html());c.type&&"div"==c.type?e.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><div class="inp-text div-modal-text" contenteditable="true" name="{param}">{value}</div></div>',
c)):e.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><input class="inp-text modal-text" type="text" name="{param}" value="{value}"/></div>',c))},this))},this));b.isFunction(c.onLoad)&&c.onLoad.call(this,a,c,d);f.find("#wbbm-submit").click(b.proxy(function(){if(!(b.isFunction(c.onSubmit)&&!1===c.onSubmit.call(this,a,c,d))){var e={},f=!0;this.$modal.find(".wbbm-inperr").remove();this.$modal.find(".wbbm-brdred").removeClass("wbbm-brdred");b.each(this.$modal.find(".tab-cont:visible .inp-text"),
b.proxy(function(a,d){var g=b(d).parents(".tab-cont").attr("tid"),h=b(d).attr("name").toLowerCase(),r="",r=b(d).is("input,textrea")?b(d).val():b(d).html(),g=c.tabs[g].input[a].validation;"undefined"!=typeof g&&!r.match(RegExp(g,"i"))&&(f=!1,b(d).after('<span class="wbbm-inperr">'+CURLANG.validation_err+"</span>").addClass("wbbm-brdred"));e[h]=r},this));f&&(b.log("Last range: "+this.lastRange),this.selectLastRange(),d&&this.wbbRemoveCallback(a,!0),this.wbbInsertCallback(a,e),this.closeModal(),this.updateUI())}},
this));f.find("#wbbm-remove").click(b.proxy(function(){this.selectLastRange();this.wbbRemoveCallback(a);this.closeModal();this.updateUI()},this));b(document.body).css("overflow","hidden");b("body").height()>b(window).height()&&b(document.body).css("padding-right","18px");this.$modal.show();f.css("margin-top",(b(window).height()-f.outerHeight())/3+"px");setTimeout(b.proxy(function(){this.$modal.find(".inp-text:visible")[0].focus()},this),10)},escModal:function(a){27==a.which&&this.closeModal()},closeModal:function(){b(document.body).css("overflow",
"auto").css("padding-right","0").unbind("keyup",this.escModal);this.$modal.find("#wbbm-submit,#wbbm-remove").unbind("click");this.$modal.hide();this.lastRange=!1;return this},getParams:function(a,c,d){var e={};if(this.options.bbmode){var f=c.match(/\{[\s\S]+?\}/g);c=this.prepareRGX(c);c=RegExp(c,"g");var g=this.txtArea.value;0<d&&(g=g.substr(d,g.length-d));var h=c.exec(g);h&&b.each(f,function(a,b){e[b.replace(/\{|\}/g,"").replace(/"/g,"'").toLowerCase()]=h[a+1]})}else b.each(this.options.rules[c][0][1],
b.proxy(function(c,d){var f="";if(f=!1!==d.attr?b(a).attr(d.attr):!1!==d.sel?b(a).find(d.sel).html():b(a).html()){if(!1!==d.rgx){var g=f.match(RegExp(d.rgx));g&&2==g.length&&(f=g[1])}e[c]=f.replace(/"/g,"'")}},this));return e},imgLoadModal:function(){b.log("imgLoadModal");!0===this.options.imgupload?(this.$modal.find("#imguploader").dragfileupload({url:this.strf(this.options.img_uploadurl,this.options),extraParams:{maxwidth:this.options.img_maxwidth,maxheight:this.options.img_maxheight},themePrefix:this.options.themePrefix,
themeName:this.options.themeName,success:b.proxy(function(a){this.$txtArea.insertImage(a.image_link,a.thumb_link);this.closeModal();this.updateUI()},this)}),b.support.htmlSerialize||(b.log("IE not posting form by security reason, show default file upload"),this.$modal.find("#nicebtn").hide(),this.$modal.find("#fileupl").css("opacity",1)),this.$modal.find("#fileupl").bind("change",function(){b("#fupform").submit()}),this.$modal.find("#fupform").bind("submit",b.proxy(function(a){b(a.target).parents("#imguploader").hide().after('<div class="loader"><img src="'+
this.options.themePrefix+"/"+this.options.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>").parent().css("text-align","center")},this))):(this.$modal.find(".hastabs").removeClass("hastabs"),this.$modal.find("#imguploader").parents(".tab-cont").remove(),this.$modal.find(".wbbm-tablist").remove())},imgSubmitModal:function(){b.log("imgSubmitModal")},printObjectInIE:function(a){try{b.log(JSON.stringify(a))}catch(c){}},checkFilter:function(a,c){b.log("node: "+b(a).get(0).outerHTML+
" filter: "+c+" res: "+b(a).is(c.toLowerCase()))},debug:function(a){if(!0===this.options.debug){var c=(new Date).getTime();"undefined"!=typeof console?console.log(c-this.startTime+" ms: "+a):b("#exlog").append("<p>"+(c-this.startTime)+" ms: "+a+"</p>");this.startTime=c}},isChrome:function(){return window.chrome?!0:!1},fixTableTransform:function(a){return!a?"":-1==b.inArray("table",this.options.buttons)?a.replace(/\<(\/*?(table|tr|td|tbody))[^>]*\>/ig,""):a.replace(/\<(\/*?(table|tr|td))[^>]*\>/ig,
"[$1]").replace(/\<\/*tbody[^>]*\>/ig,"")}};b.log=function(a){"undefined"!=typeof wbbdebug&&!0===wbbdebug&&("undefined"!=typeof console?console.log(a):b("#exlog").append("<p>"+a+"</p>"))};b.fn.wysibb=function(a){return this.each(function(){b(this).data("wbb")||new b.wysibb(this,a)})};b.fn.wdrag=function(a){a.scope||(a.scope=this);var c=0,d=0,e,f;a.scope.drag_mousedown=function(g){g.preventDefault();c=g.pageY;d=a.height;e=a.scope.$body.height();f=!0;b(document).bind("mousemove",b.proxy(a.scope.drag_mousemove,
this));b(this).addClass("drag")};a.scope.drag_mouseup=function(c){!0===f&&(c.preventDefault(),b(document).unbind("mousemove",a.scope.drag_mousemove),b(this).removeClass("drag"),f=!1)};a.scope.drag_mousemove=function(b){b.preventDefault();var f=0;a.axisY&&(f=b.pageY-c);0!=f&&(b=e+f,b>d&&b<=a.scope.options.resize_maxheight&&(!0==a.scope.options.bbmode?a.scope.$txtArea.css(!0===a.scope.options.autoresize?"min-height":"height",b+"px"):a.scope.$body.css(!0===a.scope.options.autoresize?"min-height":"height",
b+"px")))};b(this).bind("mousedown",a.scope.drag_mousedown);b(document).bind("mouseup",b.proxy(a.scope.drag_mouseup,this))};b.fn.getDoc=function(){return this.data("wbb").doc};b.fn.getSelectText=function(a){return this.data("wbb").getSelectText(a)};b.fn.bbcode=function(a){return"undefined"!=typeof a?(this.data("wbb").options.bbmode?this.data("wbb").$txtArea.val(a):this.data("wbb").$body.html(this.data("wbb").getHTML(a)),this):this.data("wbb").getBBCode()};b.fn.htmlcode=function(a){if(!this.data("wbb").options.onlyBBMode&&
!0===this.data("wbb").inited)return"undefined"!=typeof a?(this.data("wbb").$body.html(a),this):this.data("wbb").getHTML(this.data("wbb").$txtArea.val())};b.fn.getBBCode=function(){return this.data("wbb").getBBCode()};b.fn.getHTML=function(){var a=this.data("wbb");return a.getHTML(a.$txtArea.val())};b.fn.getHTMLByCommand=function(a,b){return this.data("wbb").getHTMLByCommand(a,b)};b.fn.getBBCodeByCommand=function(a,b){return this.data("wbb").getBBCodeByCommand(a,b)};b.fn.insertAtCursor=function(a,
b){this.data("wbb").insertAtCursor(a,b);return this.data("wbb")};b.fn.execCommand=function(a,b){this.data("wbb").execCommand(a,b);return this.data("wbb")};b.fn.insertImage=function(a,b){var d=this.data("wbb"),e=b?d.getCodeByCommand("link",{url:a,seltext:d.getCodeByCommand("img",{src:b})}):d.getCodeByCommand("img",{src:a});this.insertAtCursor(e);return d};b.fn.sync=function(){this.data("wbb").sync();return this.data("wbb")};b.fn.destroy=function(){this.data("wbb").destroy()};b.fn.queryState=function(a){return this.data("wbb").queryState(a)}})(jQuery);
(function(b){function a(a,d){this.$block=b(a);this.opt=b.extend({url:!1,success:!1,extraParams:!1,fileParam:"img",validation:".(jpg|png|gif|jpeg)$",t1:CURLANG.fileupload_text1,t2:CURLANG.fileupload_text2},d)}b.fn.dragfileupload=function(b){return this.each(function(){(new a(this,b)).init()})};a.prototype={init:function(){if(null!=window.FormData){this.$block.addClass("drag");this.$block.prepend('<div class="p2">'+this.opt.t2+"</div>");this.$block.prepend('<div class="p">'+this.opt.t1+"</div>");this.$block.bind("dragover",
function(){b(this).addClass("dragover");return!1});this.$block.bind("dragleave",function(){b(this).removeClass("dragover");return!1});var a=b.proxy(function(a){a=parseInt(100*(a.loaded/a.total),10);this.$loader.children("span").text(CURLANG.loading+": "+a+"%")},this),d=jQuery.ajaxSettings.xhr();d.upload&&d.upload.addEventListener("progress",a,!1);this.$block[0].ondrop=b.proxy(function(a){a.preventDefault();this.$block.removeClass("dragover");a=a.dataTransfer.files[0];if(this.opt.validation&&!a.name.match(RegExp(this.opt.validation)))return this.error(CURLANG.validation_err),
!1;var c=new FormData;c.append(this.opt.fileParam,a);this.opt.extraParams&&b.each(this.opt.extraParams,function(a,b){c.append(a,b)});this.$loader=b('<div class="loader"><img src="'+this.opt.themePrefix+"/"+this.opt.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>");this.$block.html(this.$loader);b.ajax({type:"POST",url:this.opt.url,data:c,processData:!1,contentType:!1,xhr:function(){return d},dataType:"json",success:b.proxy(function(a){a&&1==a.status?this.opt.success(a):this.error(a.msg||
CURLANG.error_onupload)},this),error:b.proxy(function(a,b,c){this.error(CURLANG.error_onupload)},this)})},this)}},error:function(a){this.$block.find(".upl-error").remove().end().append('<span class="upl-error">'+a+"</span>").addClass("wbbm-brdred")}}})(jQuery);
